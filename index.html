<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Finances">
<meta name="theme-color" content="#0a0e1a">
<title>Finance Tracker</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">

<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:#0a0e1a;font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',sans-serif;color:#e2e8f0;min-height:100vh;overflow-x:hidden;padding-top:env(safe-area-inset-top,20px)}
#app{max-width:430px;margin:0 auto;min-height:100vh;position:relative;padding-bottom:110px}
.hdr{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #131a2e;position:sticky;top:0;background:#0a0e1a;z-index:10}
.hdr-t{font-size:16px;font-weight:600;color:#e2e8f0;text-align:center;flex:1}
.del-btn{background:none;border:none;color:#ef4444;font-size:14px;cursor:pointer;font-family:inherit;min-width:60px;text-align:right}
.bb{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;padding:12px 20px calc(12px + env(safe-area-inset-bottom,8px));background:linear-gradient(180deg,transparent 0%,#0a0e1a 20%);z-index:20}
.bb-btn{width:100%;padding:16px;border-radius:14px;background:#111827;border:1px solid #1e293b;color:#3b82f6;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center}
.bb-btn:active{background:#0f1629;transform:scale(0.98)}
.dh{padding:20px 20px 24px;background:linear-gradient(180deg,#0f1629 0%,#0a0e1a 100%)}
.dt{display:flex;justify-content:space-between;align-items:center}
.dt h1{font-size:26px;font-weight:700;color:#f1f5f9;letter-spacing:-0.02em}
.ib{display:flex;gap:8px}
.ib button{background:none;border:none;font-size:18px;cursor:pointer;padding:4px 6px}
.ms{display:flex;align-items:center;justify-content:center;gap:16px;margin-top:20px}
.ma{background:none;border:none;color:#3b82f6;font-size:22px;cursor:pointer;padding:4px 8px;font-family:inherit}
.ma:disabled{opacity:0.2}
.ml{color:#94a3b8;font-size:14px;font-weight:500;min-width:140px;text-align:center}
.ds{margin-top:12px;padding:16px;background:#111827;border-radius:16px;border:1px solid #1a2236}
.ds-t{color:#475569;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px}
.da{font-size:28px;font-weight:700;font-family:monospace;letter-spacing:-0.02em}
.da.inc{color:#10b981;text-shadow:0 0 12px rgba(16,185,129,0.25)}
.da.exp{color:#f1f5f9;text-shadow:0 0 12px rgba(59,130,246,0.25)}
.da.np{color:#10b981}.da.nn{color:#ef4444}
.cnt{padding:20px}
.cl{display:flex;flex-direction:column;gap:10px}
.cr{display:flex;align-items:center;padding:18px 16px;cursor:pointer;background:#111827;border-radius:16px;border:1px solid #1a2236;transition:all 0.2s}
.cr:active{transform:scale(0.98)}
.cri{display:flex;align-items:center;gap:14px;flex:1}
.cri-i{font-size:30px;filter:drop-shadow(0 0 6px rgba(59,130,246,0.25))}
.cri-t{flex:1;display:flex;justify-content:space-between;align-items:center}
.cri-n{color:#e2e8f0;font-size:15px;font-weight:600}
.cri-a{color:#f1f5f9;font-size:17px;font-family:monospace;font-weight:700;text-shadow:0 0 12px rgba(59,130,246,0.3)}
.chv{color:#1e3a5f;font-size:18px;margin-left:8px}
.et{color:#334155;text-align:center;padding:32px 0;font-size:14px}
.bn{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;display:flex;align-items:center;justify-content:center;gap:12px;padding:12px 20px calc(12px + env(safe-area-inset-bottom,8px));background:linear-gradient(180deg,transparent 0%,#0a0e1a 25%);z-index:20}
.fab{width:60px;height:60px;border-radius:30px;background:linear-gradient(135deg,#1d4ed8,#3b82f6);border:none;color:#fff;font-size:30px;font-weight:300;cursor:pointer;box-shadow:0 4px 24px rgba(59,130,246,0.4);display:flex;align-items:center;justify-content:center}
.fab:active{transform:scale(0.93)}
.np{height:44px;padding:0 16px;border-radius:22px;background:#111827;border:1px solid #1e3a5f;color:#60a5fa;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:6px;white-space:nowrap}
.np:active{background:#0f1629}
.sc{display:flex;flex-direction:column;align-items:center;padding-top:30px}
.sl{color:#94a3b8;font-size:16px;font-weight:500;margin-bottom:20px;text-align:center}
.aw{display:flex;align-items:center;gap:4px;margin-bottom:32px}
.cs{font-size:36px;font-weight:300;color:#3b82f6;font-family:monospace}
.ai{background:none;border:none;border-bottom:2px solid #1e293b;color:#f1f5f9;font-size:36px;font-weight:700;font-family:monospace;width:180px;text-align:center;outline:none;padding:8px 0}
.ti{background:#111827;border:1px solid #1e293b;border-radius:10px;color:#e2e8f0;font-size:15px;padding:14px 16px;width:100%;outline:none;font-family:inherit}
.ti:focus{border-color:#1d4ed8}
.cg{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;max-width:320px}
.cb{display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px 8px;border-radius:12px;background:#111827;border:1px solid #1e293b;cursor:pointer;transition:all 0.15s}
.cb:active{transform:scale(0.96)}
.cb.act{border-color:#3b82f6;background:#0f1d3a}
.cb-i{font-size:24px}.cb-l{color:#94a3b8;font-size:12px;font-weight:500}
.bb2{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:28px 16px;border-radius:16px;background:#111827;border:1px solid #1e293b;cursor:pointer;transition:all 0.15s;width:100%}
.bb2:active{transform:scale(0.97)}
.bb2.sel{border-color:#3b82f6;background:#0f1d3a}
.bb2-i{font-size:36px}.bb2-l{color:#e2e8f0;font-size:16px;font-weight:600}
.to{display:flex;gap:10px;width:100%;max-width:320px}
.to button{flex:1;padding:14px 8px;border-radius:12px;background:#111827;border:1px solid #1e293b;cursor:pointer;text-align:center;font-size:14px;font-weight:600;color:#94a3b8;font-family:inherit}
.to button.act{border-color:#3b82f6;background:#0f1d3a;color:#e2e8f0}
.to button:active{transform:scale(0.96)}
.pb{background:linear-gradient(135deg,#1d4ed8,#3b82f6);border:none;color:#fff;font-size:15px;font-weight:600;padding:14px 32px;border-radius:12px;cursor:pointer;width:100%;font-family:inherit}
.pb:disabled{opacity:0.3}.pb:active{opacity:0.8}
.sb{background:#111827;border:1px solid #1e293b;color:#94a3b8;font-size:15px;font-weight:500;padding:14px 24px;border-radius:12px;cursor:pointer;width:100%;font-family:inherit}
.br{display:flex;gap:12px;margin-top:24px;width:100%}
.dots{display:flex;gap:8px;justify-content:center;margin-top:30px}
.dot{width:8px;height:8px;border-radius:4px;background:#1e293b;transition:all 0.2s}
.dot.act{background:#3b82f6;width:20px}
.li{display:flex;justify-content:space-between;align-items:center;padding:14px 4px;border-bottom:1px solid #111827;cursor:pointer}
.li:active{background:#0f1629}
.la{color:#e2e8f0;font-size:15px;font-weight:600;font-family:monospace}
.ln{color:#64748b;font-size:13px;margin-top:2px}
.ld{color:#475569;font-size:12px;margin-top:2px}
.lc{color:#334155;font-size:18px}
.lr{display:flex;align-items:center;gap:10px}
.bt{font-size:32px;font-weight:700;color:#f1f5f9;text-align:center;margin:8px 0 4px;font-family:monospace;letter-spacing:-0.02em}
.st{color:#475569;font-size:13px;text-align:center}
.sm{display:flex;justify-content:space-between;margin-top:16px;margin-bottom:8px}
.stl{color:#3b82f6;font-family:monospace;font-size:14px}
.eb{background:#111827;border:1px solid #1e293b;color:#3b82f6;font-size:14px;font-weight:500;padding:12px 20px;border-radius:12px;cursor:pointer;width:100%;font-family:inherit;margin-top:12px;display:flex;align-items:center;justify-content:center;gap:8px}
.eb:active{background:#0f1629}
.tb{display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600;background:#1e3a5f;color:#60a5fa}
.ub{display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600;background:#064e3b;color:#34d399}
.nub{display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600;background:#4c1d95;color:#a78bfa}
.vc{padding:20px;background:#111827;border-radius:16px;border:1px solid #1a2236;margin-bottom:12px}
.vl{color:#475569;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px}
.va{font-size:24px;font-weight:700;font-family:monospace;color:#f1f5f9}
.vw{color:#f59e0b;font-size:13px;margin-top:6px;font-weight:500}
.co{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:100;display:flex;align-items:center;justify-content:center;padding:20px}
.cob{background:#111827;border:1px solid #1e293b;border-radius:16px;padding:24px;max-width:340px;width:100%;text-align:center}
.cot{color:#f1f5f9;font-size:18px;font-weight:700;margin-bottom:8px}
.cox{color:#94a3b8;font-size:14px;margin-bottom:20px;line-height:1.5}
.pi{background:none;border:none;border-bottom:2px solid #1e293b;color:#f1f5f9;font-size:28px;font-weight:700;font-family:monospace;width:100px;text-align:center;outline:none;padding:8px 0}
.cw{width:100%;display:flex;justify-content:center;padding:8px 0}
.cw svg{width:100%;max-width:360px;height:auto}
.ncr{display:flex;gap:8px;margin-top:8px}
.ei{width:52px;text-align:center;padding:10px 4px!important}
</style>
</head>
<body>
<div id="app"></div>
<script>
(function(){
const SK_E='ft-exp',SK_I='ft-inc',SK_C='ft-cat',SK_T='ft-ty',SK_TS='ft-tys';
const DC=[
{id:'food',name:'Food',icon:'üõí'},{id:'household',name:'Household',icon:'üè†'},
{id:'restaurants',name:'Restaurants',icon:'üçΩÔ∏è'},{id:'travel',name:'Travel',icon:'üöÜ'},
{id:'subscriptions',name:'Subscriptions',icon:'üîÅ'},{id:'rent',name:'Rent',icon:'üè°'},
{id:'utilities',name:'Utilities',icon:'üí°'},{id:'debt',name:'Debt',icon:'üí≥'},
{id:'entertainment',name:'Entertainment',icon:'üé¨'},{id:'giving',name:'Giving',icon:'ü§≤'},
{id:'miscellaneous',name:'Miscellaneous',icon:'üì¶'}
];
let S={expenses:[],income:[],categories:[...DC],pastTY:[],view:'dashboard',
addType:'',addStep:0,addExp:{amount:'',description:'',category:'',taxable:'no',taxPct:''},
addInc:{amount:'',description:'',source:'uk'},selCat:null,selMonth:cmk(),
searchMode:'',searchQ:'',editing:null,editData:{},
newCN:'',newCI:'üìå',confirm:null,exportStep:null,exportScope:null,tyStart:null};

function ld(){
try{let d=localStorage.getItem(SK_E);if(d)S.expenses=JSON.parse(d)}catch(e){}
try{let d=localStorage.getItem(SK_I);if(d)S.income=JSON.parse(d)}catch(e){}
try{let d=localStorage.getItem(SK_C);if(d)S.categories=JSON.parse(d)}catch(e){}
try{let d=localStorage.getItem(SK_T);if(d)S.pastTY=JSON.parse(d)}catch(e){}
try{let d=localStorage.getItem(SK_TS);if(d)S.tyStart=d}catch(e){}
if(!S.tyStart){let n=new Date(),y=n.getMonth()>=3?n.getFullYear():n.getFullYear()-1;S.tyStart=y+'-04-06'}
}
function sE(){localStorage.setItem(SK_E,JSON.stringify(S.expenses))}
function sI(){localStorage.setItem(SK_I,JSON.stringify(S.income))}
function sC(){localStorage.setItem(SK_C,JSON.stringify(S.categories))}
function sT(){localStorage.setItem(SK_T,JSON.stringify(S.pastTY))}
function sTS(){localStorage.setItem(SK_TS,S.tyStart)}

function fc(a){return '¬£'+Number(a).toFixed(2)}
function gmk(d){let t=new Date(d);return t.getFullYear()+'-'+String(t.getMonth()+1).padStart(2,'0')}
function gml(k){let[y,m]=k.split('-');return new Date(y,parseInt(m)-1).toLocaleDateString('en-GB',{month:'long',year:'numeric'})}
function cmk(){return gmk(new Date())}
function gcn(id){return(S.categories.find(c=>c.id===id)||{}).name||id}
function gci(id){return(S.categories.find(c=>c.id===id)||{}).icon||'üì¶'}
function esc(s){let d=document.createElement('div');d.textContent=s;return d.innerHTML}
function gme(){return S.expenses.filter(e=>gmk(e.date)===S.selMonth)}
function gmi(){return S.income.filter(e=>gmk(e.date)===S.selMonth)}
function tyl(){let s=new Date(S.tyStart),y1=s.getFullYear(),y2=y1+1;return y1+'/'+y2}
function gte(){let st=new Date(S.tyStart),now=new Date();return S.expenses.filter(e=>{let d=new Date(e.date);return d>=st&&d<=now&&e.taxable!=='no'&&Number(e.taxAmount)>0})}
function r12(src){let now=new Date(),y1=new Date(now);y1.setFullYear(y1.getFullYear()-1);return S.income.filter(i=>{let d=new Date(i.date);if(d<y1||d>now)return false;if(src==='uk')return i.source==='uk';if(src==='nonuk')return i.source==='nonuk';return true})}
function bb(a,l){return '<div class="bb"><button class="bb-btn" data-action="'+a+'">‚Üê '+(l||'Back')+'</button></div>'}
function dots(n,c){return '<div class="dots">'+[0,1,2].map(i=>'<div class="dot '+(c===i?'act':'')+'"></div>').join('')+'</div>'}
function fd(d){return new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short'})}
function fdy(d){return new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}

function render(){
let app=document.getElementById('app');
if(S.confirm){app.innerHTML=renderConfirm()+app.innerHTML;bind();return}
switch(S.view){
case 'add-type':app.innerHTML=rAddType();break;
case 'add-exp':app.innerHTML=rAddExp();break;
case 'add-inc':app.innerHTML=rAddInc();break;
case 'edit-exp':app.innerHTML=rEditExp();break;
case 'edit-inc':app.innerHTML=rEditInc();break;
case 'category':app.innerHTML=rCat();break;
case 'exp-list':app.innerHTML=rExpList();break;
case 'inc-list':app.innerHTML=rIncList();break;
case 'search-type':app.innerHTML=rSearchType();break;
case 'search':app.innerHTML=rSearch();break;
case 'trends':app.innerHTML=rTrends();break;
case 'settings':app.innerHTML=rSettings();break;
case 'tax':app.innerHTML=rTax();break;
case 'vat':app.innerHTML=rVat();break;
case 'past-tax':app.innerHTML=rPastTax();break;
case 'export':app.innerHTML=rExport();break;
case 'report':app.innerHTML=rReport();break;
default:app.innerHTML=rDash();break;
}
bind();window.scrollTo(0,0);
}

function rDash(){
let me=gme(),mi=gmi();
let tE=me.reduce((s,e)=>s+Number(e.amount),0);
let tI=mi.reduce((s,e)=>s+Number(e.amount),0);
let net=tI-tE,isCur=S.selMonth===cmk();
let nc=net>=0?"#10b981":"#ef4444";
let ngl=net>=0?"0 0 30px rgba(16,185,129,0.4),inset 0 0 30px rgba(16,185,129,0.1)":"0 0 30px rgba(239,68,68,0.4),inset 0 0 30px rgba(239,68,68,0.1)";
let nbr=net>=0?"#10b981":"#ef4444";
let fi=Number(tI).toFixed(2),fe=Number(tE).toFixed(2),fn=Math.abs(net).toFixed(2);
return '<div class="dh"><div class="dt"><h1>Finances</h1><div class="ib"><button data-action="go-search-type">üîç</button><button data-action="go-export">üì§</button><button data-action="go-settings">‚öôÔ∏è</button></div></div>'+
'<div class="ms"><button class="ma" data-action="prev-m">‚Äπ</button><span class="ml">'+gml(S.selMonth)+'</span><button class="ma" data-action="next-m" '+(isCur?"disabled":"")+'>‚Ä∫</button></div></div>'+
'<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:calc(100vh - 190px);padding:0 12px">'+
'<div style="display:flex;justify-content:center;gap:12px;width:100%">'+
'<div data-action="go-inc-list" style="cursor:pointer;width:46vw;height:46vw;max-width:190px;max-height:190px;border-radius:50%;border:2.5px solid #3b82f6;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 0 25px rgba(59,130,246,0.35),inset 0 0 25px rgba(59,130,246,0.08)">'+
'<p style="font-size:11px;font-weight:700;color:#60a5fa;text-transform:uppercase;letter-spacing:0.12em;margin-bottom:6px">Income</p>'+
'<p style="font-size:min(5.5vw,22px);font-weight:700;color:#60a5fa;font-family:monospace">'+fi+'</p>'+
'</div>'+
'<div data-action="go-exp-list" style="cursor:pointer;width:46vw;height:46vw;max-width:190px;max-height:190px;border-radius:50%;border:2.5px solid #ef4444;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 0 25px rgba(239,68,68,0.35),inset 0 0 25px rgba(239,68,68,0.08)">'+
'<p style="font-size:11px;font-weight:700;color:#f87171;text-transform:uppercase;letter-spacing:0.12em;margin-bottom:6px">Expenses</p>'+
'<p style="font-size:min(5.5vw,22px);font-weight:700;color:#f87171;font-family:monospace">'+fe+'</p>'+
'</div>'+
'</div>'+
'<div style="display:flex;justify-content:center;margin-top:16px">'+
'<div style="width:60vw;height:60vw;max-width:250px;max-height:250px;border-radius:50%;border:3px solid '+nbr+';display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:'+ngl+'">'+
'<p style="font-size:14px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:0.15em;margin-bottom:8px">Net</p>'+
'<p style="font-size:min(7.5vw,32px);font-weight:700;color:'+nc+';font-family:monospace">'+fn+'</p>'+
'</div>'+
'</div>'+
'</div>'+
'<div class="bn"><button class="fab" data-action="go-add-type">+</button><button class="np" data-action="go-tax">üìã Tax</button><button class="np" data-action="go-vat">üìä VAT</button></div>';
}

function rAddType(){
return '<div class="hdr"><span class="hdr-t">New Entry</span></div><div class="cnt"><div style="display:flex;gap:12px;margin-top:20px">'+
'<button class="bb2" data-action="start-add-exp"><span class="bb2-i">üí∏</span><span class="bb2-l">Expense</span></button>'+
'<button class="bb2" data-action="start-add-inc"><span class="bb2-i">üí∞</span><span class="bb2-l">Income</span></button></div></div>'+bb('go-dash','Cancel');
}

function rAddExp(){
let s=S.addStep,sc='';
if(s===0){sc='<div class="sc"><p class="sl">How much did you spend?</p><div class="aw"><span class="cs">¬£</span><input type="number" inputmode="decimal" placeholder="0.00" class="ai" id="aA" value="'+S.addExp.amount+'" autofocus></div><button class="pb" data-action="en1" '+((!S.addExp.amount||parseFloat(S.addExp.amount)<=0)?'disabled':'')+'>Next</button></div>'}
else if(s===1){sc='<div class="sc"><p class="sl">Description</p><input type="text" placeholder="e.g. Tesco, Netflix, Rent..." class="ti" id="aD" value="'+esc(S.addExp.description)+'" autofocus><button class="pb" style="margin-top:24px" data-action="en2" '+(!S.addExp.description.trim()?'disabled':'')+'>Next</button></div>'}
else if(s===2){let b=S.categories.map(c=>'<button class="cb '+(S.addExp.category===c.id?'act':'')+'" data-action="esc" data-id="'+c.id+'"><span class="cb-i">'+c.icon+'</span><span class="cb-l">'+esc(c.name)+'</span></button>').join('');
sc='<div class="sc"><p class="sl">What was it for?</p><div class="cg">'+b+'</div></div>'}
else if(s===3){sc='<div class="sc"><p class="sl">Is this taxable?</p><div class="to">'+
'<button '+(S.addExp.taxable==='yes'?'class="act"':'')+' data-action="etx" data-val="yes">Yes<br><span style="font-size:11px;color:#64748b">100%</span></button>'+
'<button '+(S.addExp.taxable==='no'?'class="act"':'')+' data-action="etx" data-val="no">No<br><span style="font-size:11px;color:#64748b">0%</span></button>'+
'<button '+(S.addExp.taxable==='pct'?'class="act"':'')+' data-action="etx" data-val="pct">%<br><span style="font-size:11px;color:#64748b">Custom</span></button></div>'+
(S.addExp.taxable==='pct'?'<div style="margin-top:20px;display:flex;align-items:center;gap:4px"><input type="number" inputmode="decimal" placeholder="16" class="pi" id="aP" value="'+S.addExp.taxPct+'" autofocus><span style="font-size:24px;color:#3b82f6;font-family:monospace">%</span></div>':'')+
'<button class="pb" style="margin-top:24px" data-action="esv" '+(S.addExp.taxable==='pct'&&!S.addExp.taxPct?'disabled':'')+'>Save</button></div>'}
let dt=[0,1,2,3].map(i=>'<div class="dot '+(s===i?'act':'')+'"></div>').join('');
return '<div class="hdr"><span class="hdr-t">Add Expense</span></div><div class="cnt">'+sc+'<div class="dots">'+dt+'</div></div>'+bb('go-dash','Cancel');
}

function rAddInc(){
let s=S.addStep,sc='';
if(s===0){sc='<div class="sc"><p class="sl">How much did you receive?</p><div class="aw"><span class="cs">¬£</span><input type="number" inputmode="decimal" placeholder="0.00" class="ai" id="iA" value="'+S.addInc.amount+'" autofocus></div><button class="pb" data-action="in1" '+((!S.addInc.amount||parseFloat(S.addInc.amount)<=0)?'disabled':'')+'>Next</button></div>'}
else if(s===1){sc='<div class="sc"><p class="sl">Description</p><input type="text" placeholder="e.g. JLS, Icon Amsterdam..." class="ti" id="iD" value="'+esc(S.addInc.description)+'" autofocus><button class="pb" style="margin-top:24px" data-action="in2" '+(!S.addInc.description.trim()?'disabled':'')+'>Next</button></div>'}
else if(s===2){sc='<div class="sc"><p class="sl">Where is this income from?</p><div style="display:flex;gap:12px;width:100%;max-width:320px">'+
'<button class="bb2 '+(S.addInc.source==='uk'?'sel':'')+'" data-action="isr" data-val="uk" style="padding:20px"><span class="bb2-i">üá¨üáß</span><span class="bb2-l">UK</span></button>'+
'<button class="bb2 '+(S.addInc.source==='nonuk'?'sel':'')+'" data-action="isr" data-val="nonuk" style="padding:20px"><span class="bb2-i">üåç</span><span class="bb2-l">Outside UK</span></button></div>'+
'<button class="pb" style="margin-top:24px" data-action="isv">Save</button></div>'}
return '<div class="hdr"><span class="hdr-t">Add Income</span></div><div class="cnt">'+sc+dots(3,s)+'</div>'+bb('go-dash','Cancel');
}

function rEditExp(){
if(!S.editing)return rDash();let d=S.editData;
let cb=S.categories.map(c=>'<button class="cb '+(d.category===c.id?'act':'')+'" data-action="eec" data-id="'+c.id+'"><span style="font-size:20px">'+c.icon+'</span><span class="cb-l">'+esc(c.name)+'</span></button>').join('');
return '<div class="hdr"><span class="hdr-t" style="flex:1">Edit Expense</span><button class="del-btn" data-action="del-exp">Delete</button></div>'+
'<div class="cnt"><div class="sc"><p class="sl">Amount</p><div class="aw"><span class="cs">¬£</span><input type="number" inputmode="decimal" class="ai" id="eA" value="'+d.amount+'"></div>'+
'<p class="sl" style="margin-top:24px">Description</p><input type="text" class="ti" id="eD" value="'+esc(d.description||'')+'">'+
'<p class="sl" style="margin-top:24px">Category</p><div class="cg">'+cb+'</div>'+
'<p class="sl" style="margin-top:24px">Taxable</p><div class="to">'+
'<button '+(d.taxable==='yes'?'class="act"':'')+' data-action="eet" data-val="yes">Yes</button>'+
'<button '+(d.taxable==='no'?'class="act"':'')+' data-action="eet" data-val="no">No</button>'+
'<button '+(d.taxable==='pct'?'class="act"':'')+' data-action="eet" data-val="pct">%</button></div>'+
(d.taxable==='pct'?'<div style="margin-top:12px;display:flex;align-items:center;gap:4px"><input type="number" inputmode="decimal" class="pi" id="eP" value="'+(d.taxPct||'')+'"><span style="font-size:24px;color:#3b82f6;font-family:monospace">%</span></div>':'')+
'<button class="pb" style="margin-top:24px" data-action="sve-exp">Save Changes</button></div></div>'+bb('go-dash','Cancel');
}

function rEditInc(){
if(!S.editing)return rDash();let d=S.editData;
return '<div class="hdr"><span class="hdr-t" style="flex:1">Edit Income</span><button class="del-btn" data-action="del-inc">Delete</button></div>'+
'<div class="cnt"><div class="sc"><p class="sl">Amount</p><div class="aw"><span class="cs">¬£</span><input type="number" inputmode="decimal" class="ai" id="eiA" value="'+d.amount+'"></div>'+
'<p class="sl" style="margin-top:24px">Description</p><input type="text" class="ti" id="eiD" value="'+esc(d.description)+'">'+
'<p class="sl" style="margin-top:24px">Source</p><div style="display:flex;gap:12px;width:100%;max-width:320px">'+
'<button class="bb2 '+(d.source==='uk'?'sel':'')+'" data-action="eis" data-val="uk" style="padding:16px"><span style="font-size:24px">üá¨üáß</span><span class="bb2-l" style="font-size:14px">UK</span></button>'+
'<button class="bb2 '+(d.source==='nonuk'?'sel':'')+'" data-action="eis" data-val="nonuk" style="padding:16px"><span style="font-size:24px">üåç</span><span class="bb2-l" style="font-size:14px">Outside UK</span></button></div>'+
'<button class="pb" style="margin-top:24px" data-action="sve-inc">Save Changes</button></div></div>'+bb('go-dash','Cancel');
}

function rExpList(){
let me=gme();
let tE=me.reduce((s,e)=>s+Number(e.amount),0);
let ct=S.categories.map(c=>({...c,total:me.filter(e=>e.category===c.id).reduce((s,e)=>s+Number(e.amount),0),count:me.filter(e=>e.category===c.id).length})).filter(c=>c.total>0||c.count>0).sort((a,b)=>b.total-a.total);
let cc=ct.length===0?'<p class="et">No expenses this month</p>':
ct.map(c=>'<div class="cr" data-action="view-cat" data-id="'+c.id+'"><div class="cri"><span class="cri-i">'+c.icon+'</span><div class="cri-t"><span class="cri-n">'+esc(c.name)+'</span><span class="cri-a">'+fc(c.total)+'</span></div></div><span class="chv">‚Ä∫</span></div>').join('');
return '<div class="hdr"><span class="hdr-t">üí∏ Expenses</span></div><div class="cnt"><p class="bt">'+fc(tE)+'</p><p class="st">'+gml(S.selMonth)+'</p><div style="margin-top:16px" class="cl">'+cc+'</div></div>'+bb('go-dash','Back to Dashboard');
}

function rCat(){
let ce=gme().filter(e=>e.category===S.selCat).sort((a,b)=>new Date(b.date)-new Date(a.date));
let ct=ce.reduce((s,e)=>s+Number(e.amount),0);
let it=ce.length===0?'<p class="et">No entries yet</p>':ce.map(e=>'<div class="li" data-action="eei" data-id="'+e.id+'"><div><p class="la">'+fc(e.amount)+'</p>'+
(e.description?'<p class="ln">'+esc(e.description)+'</p>':'')+
(e.taxable!=='no'?'<span class="tb">'+(e.taxable==='yes'?'100%':e.taxPct+'%')+' taxable</span>':'')+
'<p class="ld">'+fd(e.date)+'</p></div><span class="lc">‚Ä∫</span></div>').join('');
return '<div class="hdr"><span class="hdr-t">'+gci(S.selCat)+' '+esc(gcn(S.selCat))+'</span></div><div class="cnt"><p class="bt">'+fc(ct)+'</p><p class="st">'+gml(S.selMonth)+'</p>'+it+'</div>'+bb('go-exp-list','Back to Expenses');
}

function rIncList(){
let mi=gmi().sort((a,b)=>new Date(b.date)-new Date(a.date));
let t=mi.reduce((s,e)=>s+Number(e.amount),0);
let it=mi.length===0?'<p class="et">No income this month</p>':mi.map(e=>'<div class="li" data-action="eii" data-id="'+e.id+'"><div><div class="lr"><p class="la">'+fc(e.amount)+'</p></div><p class="ln">'+esc(e.description)+'</p><p class="ld">'+(e.source==='uk'?'<span class="ub">UK</span>':'<span class="nub">Non-UK</span>')+' ¬∑ '+fd(e.date)+'</p></div><span class="lc">‚Ä∫</span></div>').join('');
return '<div class="hdr"><span class="hdr-t">üí∞ Income</span></div><div class="cnt"><p class="bt" style="color:#10b981">'+fc(t)+'</p><p class="st">'+gml(S.selMonth)+'</p>'+it+'</div>'+bb('go-dash','Back to Dashboard');
}

function rSearchType(){
return '<div class="hdr"><span class="hdr-t">Search</span></div><div class="cnt"><div style="display:flex;gap:12px;margin-top:20px">'+
'<button class="bb2" data-action="s-exp"><span class="bb2-i">üí∏</span><span class="bb2-l">Expenses</span></button>'+
'<button class="bb2" data-action="s-inc"><span class="bb2-i">üí∞</span><span class="bb2-l">Income</span></button></div></div>'+bb('go-dash','Back');
}

function rSearch(){
let isI=S.searchMode==='income',res='';
if(S.searchQ.trim()){let q=S.searchQ.toLowerCase(),matches;
if(isI){matches=S.income.filter(e=>e.description.toLowerCase().includes(q))}
else{matches=S.expenses.filter(e=>gcn(e.category).toLowerCase().includes(q))}
let tot=matches.reduce((s,e)=>s+Number(e.amount),0);
res='<div class="sm"><span class="st">'+matches.length+' result'+(matches.length!==1?'s':'')+'</span><span class="stl">Total: '+fc(tot)+'</span></div>';
if(isI){res+=matches.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(e=>'<div class="li" data-action="eii" data-id="'+e.id+'"><div><p class="la">'+fc(e.amount)+'</p><p class="ln">'+esc(e.description)+'</p><p class="ld">'+(e.source==='uk'?'UK':'Non-UK')+' ¬∑ '+fdy(e.date)+'</p></div><span class="lc">‚Ä∫</span></div>').join('')}
else{res+=matches.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(e=>'<div class="li" data-action="eei" data-id="'+e.id+'"><div><div class="lr"><span>'+gci(e.category)+'</span><p class="la">'+fc(e.amount)+'</p></div><p class="ld">'+esc(gcn(e.category))+' ¬∑ '+fdy(e.date)+'</p></div><span class="lc">‚Ä∫</span></div>').join('')}}
return '<div class="hdr"><span class="hdr-t">Search '+(isI?'Income':'Expenses')+'</span></div><div class="cnt"><input type="text" placeholder="Search..." class="ti" id="sI" value="'+esc(S.searchQ)+'" autofocus>'+res+'</div>'+bb('go-stype','Back');
}

function rTax(){
let te=gte(),tot=te.reduce((s,e)=>s+Number(e.taxAmount),0);
let it=te.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(e=>'<div class="li" data-action="eei" data-id="'+e.id+'" style="padding:14px 4px;border-bottom:1px solid #111827"><div><div style="display:flex;justify-content:space-between;align-items:center"><span class="la">'+fc(e.taxAmount)+'</span><span class="tb">'+(e.taxable==='yes'?'100%':e.taxPct+'%')+'</span></div><p class="ld">'+gci(e.category)+' '+esc(gcn(e.category))+' ¬∑ '+fdy(e.date)+'</p></div></div>').join('');
return '<div class="hdr"><span class="hdr-t">üìã Tax Summary</span></div><div class="cnt"><p class="st">Tax Year '+tyl()+'</p><p class="bt">'+fc(tot)+'</p><p class="st">Total Taxable Expenses</p><div style="margin-top:16px">'+
(it||'<p class="et">No taxable expenses yet</p>')+'</div>'+
'<button class="eb" style="margin-top:20px;border-color:#ef4444;color:#ef4444" data-action="reset-ty">üîÑ Reset Tax Year</button>'+
(S.pastTY.length>0?'<button class="eb" data-action="go-pty">üìÅ Past Tax Years</button>':'')+'</div>'+bb('go-dash','Back to Dashboard');
}

function rVat(){
let uk=r12('uk'),nuk=r12('nonuk'),all=r12('all');
let uT=uk.reduce((s,e)=>s+Number(e.amount),0),nT=nuk.reduce((s,e)=>s+Number(e.amount),0),aT=all.reduce((s,e)=>s+Number(e.amount),0);
let vt=90000,pc=Math.min((uT/vt)*100,100);
return '<div class="hdr"><span class="hdr-t">üìä VAT Summary</span></div><div class="cnt"><p class="st">Rolling 12 Months</p>'+
'<div class="vc" style="margin-top:16px"><div class="vl">üá¨üáß UK Income</div><div class="va" style="color:#10b981">'+fc(uT)+'</div>'+
'<div style="height:6px;background:#0a0e1a;border-radius:3px;margin-top:10px;overflow:hidden"><div style="height:100%;width:'+pc+'%;background:'+(pc>=90?'#ef4444':pc>=70?'#f59e0b':'#10b981')+';border-radius:3px;transition:width 0.5s"></div></div>'+
'<p style="color:#475569;font-size:11px;margin-top:4px">'+fc(uT)+' of '+fc(vt)+' VAT threshold</p>'+
(uT>=85000?'<p class="vw">‚ö†Ô∏è Approaching VAT threshold!</p>':'')+'</div>'+
'<div class="vc"><div class="vl">üåç Non-UK Income</div><div class="va" style="color:#a78bfa">'+fc(nT)+'</div></div>'+
'<div class="vc"><div class="vl">Combined Total</div><div class="va">'+fc(aT)+'</div></div></div>'+bb('go-dash','Back to Dashboard');
}

function rPastTax(){
let it=S.pastTY.map(t=>'<div class="li" style="cursor:default"><div><p class="la">'+esc(t.label)+'</p><p class="ln">Taxable: '+fc(t.totalTaxable)+' ¬∑ Expenses: '+fc(t.totalExpenses)+' ¬∑ Income: '+fc(t.totalIncome)+'</p></div></div>').join('');
return '<div class="hdr"><span class="hdr-t">üìÅ Past Tax Years</span></div><div class="cnt">'+(it||'<p class="et">No past tax years</p>')+'</div>'+bb('go-tax','Back to Tax');
}

function rTrends(){
let mm={};S.expenses.forEach(e=>{let k=gmk(e.date);mm[k]=(mm[k]||0)+Number(e.amount)});
let sk=Object.keys(mm).sort().slice(-6),ch='';
if(sk.length>=1){let vl=sk.map(m=>mm[m]),mx=Math.max(...vl,1),cW=320,cH=160,pL=50,pR=16,pT=16,pB=40,iW=cW-pL-pR,iH=cH-pT-pB;
let pts=sk.map((m,i)=>({x:pL+(sk.length===1?iW/2:(i/(sk.length-1))*iW),y:pT+iH-(mm[m]/mx)*iH,m}));
let ln=pts.map((p,i)=>(i===0?'M':'L')+' '+p.x+' '+p.y).join(' ');
let ar=ln+' L '+pts[pts.length-1].x+' '+(pT+iH)+' L '+pts[0].x+' '+(pT+iH)+' Z';
let gl=[0,.25,.5,.75,1].map(f=>{let y=pT+iH-f*iH,v=f*mx;return'<line x1="'+pL+'" y1="'+y+'" x2="'+(pL+iW)+'" y2="'+y+'" stroke="#1e293b" stroke-width="1"/><text x="'+(pL-6)+'" y="'+(y+4)+'" text-anchor="end" fill="#64748b" font-size="9" font-family="monospace">¬£'+(v>=1000?(v/1000).toFixed(1)+'k':Math.round(v))+'</text>'}).join('');
let dt=pts.map(p=>'<circle cx="'+p.x+'" cy="'+p.y+'" r="4" fill="#0f172a" stroke="#3b82f6" stroke-width="2"/><text x="'+p.x+'" y="'+(cH-8)+'" text-anchor="middle" fill="#94a3b8" font-size="8.5" font-family="monospace">'+new Date(p.m+'-01').toLocaleDateString('en-GB',{month:'short'})+'</text>').join('');
ch='<div class="cw"><svg viewBox="0 0 '+cW+' '+cH+'"><defs><linearGradient id="ag" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#3b82f6" stop-opacity="0.3"/><stop offset="100%" stop-color="#3b82f6" stop-opacity="0.02"/></linearGradient></defs>'+gl+(pts.length>1?'<path d="'+ar+'" fill="url(#ag)"/>':'')+'<path d="'+ln+'" fill="none" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>'+dt+'</svg></div>'}
return '<div class="hdr"><span class="hdr-t">Trends</span></div><div class="cnt"><p class="sl" style="margin-bottom:4px">Monthly Spending</p>'+ch+'</div>'+bb('go-dash','Back to Dashboard');
}

function rSettings(){
let di=DC.map(c=>c.id);
let lb=localStorage.getItem('ft-lastbackup');
let bkLabel=lb?'Last backup: '+new Date(lb).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}):'Never backed up';
let daysSince=lb?Math.floor((Date.now()-new Date(lb).getTime())/(1000*60*60*24)):-1;
let bkWarn=daysSince>30||daysSince===-1;
let cl=S.categories.map(c=>'<div class="li" style="cursor:default"><div style="display:flex;align-items:center;gap:12px"><span style="font-size:22px">'+c.icon+'</span><span style="color:#e2e8f0;font-size:15px">'+esc(c.name)+'</span></div>'+(!di.includes(c.id)?'<button class="del-btn" data-action="del-cat" data-id="'+c.id+'">Remove</button>':'')+'</div>').join('');
return '<div class="hdr"><span class="hdr-t">Settings</span></div><div class="cnt">'+
'<div style="margin-bottom:28px;padding:20px;background:#111827;border-radius:16px;border:1px solid '+(bkWarn?'#f59e0b':'#1a2236')+'">'+
'<p style="font-size:15px;font-weight:700;color:#f1f5f9;margin-bottom:4px">üíæ Backup & Restore</p>'+
'<p style="font-size:12px;color:'+(bkWarn?'#f59e0b':'#64748b')+';margin-bottom:14px">'+(bkWarn?'‚ö†Ô∏è ':'')+bkLabel+'</p>'+
'<button class="eb" data-action="do-backup" style="margin:0;background:#0f1d3a;border-color:#1d4ed8;color:#60a5fa">üì• Download Backup</button>'+
'<button class="eb" data-action="do-restore" style="margin-top:8px;background:#0f1d3a;border-color:#059669;color:#34d399">üì§ Restore from Backup</button>'+
'<input type="file" id="restoreFile" accept=".json" style="display:none">'+
'</div>'+
'<p class="sl" style="text-align:left">Categories</p>'+cl+
'<div style="margin-top:24px"><p class="sl">Add New Category</p><div class="ncr"><input type="text" placeholder="Emoji" class="ti ei" id="nCI" value="'+esc(S.newCI)+'" maxlength="2"><input type="text" placeholder="Category name" class="ti" id="nCN" value="'+esc(S.newCN)+'" style="flex:1"></div>'+
'<button class="pb" style="margin-top:12px" data-action="add-cat" '+(!S.newCN.trim()?'disabled':'')+'>Add Category</button></div>'+
'<div style="margin-top:24px"><p class="sl" style="text-align:left">Tax Year Start</p><input type="date" class="ti" id="tyS" value="'+S.tyStart+'"><button class="sb" style="margin-top:8px" data-action="save-tys">Update Tax Year Start</button></div>'+
'<button class="eb" data-action="go-trends" style="margin-top:16px">üìà View Trends</button></div>'+bb('go-dash','Back to Dashboard');
}

function rReport(){
if(!S.reportData)return rDash();
let d=S.reportData,P=d.P,isTax=d.scope==='taxyear'||d.scope==='pasttax';
let th='padding:7px 10px;text-align:left;font-size:10px',td='padding:5px 10px;border-bottom:1px solid #e5e7eb',tdr=td+';text-align:right';
let h='<div class="hdr"><span class="hdr-t">'+(isTax?'Tax Year Report':'Monthly Report')+'</span></div>';
h+='<div class="cnt" style="background:#fff;color:#1a1a2e;border-radius:12px;padding:20px;margin-bottom:20px">';
h+='<div style="border-bottom:3px solid #1d4ed8;padding-bottom:10px;margin-bottom:16px"><p style="color:#1d4ed8;font-size:20px;font-weight:700">'+(isTax?'Tax Year Report':'Monthly Report')+'</p><p style="color:#666;font-size:12px">'+d.title+' &middot; '+new Date().toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'})+'</p></div>';
// EXPENSES SECTION
if(isTax){
// Tax year: only taxable expenses, grouped by category, itemised
let taxExps=d.exps.filter(e=>e.taxable!=='no'&&Number(e.taxAmount)>0);
if(taxExps.length>0){
h+='<p style="color:#1d4ed8;font-size:14px;font-weight:700;margin:16px 0 8px;padding-bottom:4px;border-bottom:1px solid #ddd">Taxable Expenses</p>';
let catMap={};taxExps.forEach(e=>{let c=e.category;if(!catMap[c])catMap[c]=[];catMap[c].push(e)});
let cats=Object.keys(catMap).sort();
cats.forEach(c=>{
let items=catMap[c].sort((a,b)=>new Date(a.date)-new Date(b.date));
let catTax=items.reduce((s,e)=>s+Number(e.taxAmount),0);
h+='<p style="font-size:13px;font-weight:700;margin:14px 0 6px;color:#334155">'+gci(c)+' '+gcn(c)+'</p>';
h+='<table style="width:100%;border-collapse:collapse;font-size:11px"><tr style="background:#1d4ed8;color:#fff"><th style="'+th+'">Date</th><th style="'+th+'">Description</th><th style="'+th+'">Amount</th><th style="'+th+';text-align:right">Taxable Amount</th></tr>';
items.forEach((e,i)=>{h+='<tr style="'+(i%2===1?'background:#f8fafc':'')+'"><td style="'+td+'">'+new Date(e.date).toLocaleDateString('en-GB')+'</td><td style="'+td+'">'+(e.description||'-')+'</td><td style="'+td+'">'+P+Number(e.amount).toFixed(2)+'</td><td style="'+tdr+';font-weight:600">'+P+Number(e.taxAmount).toFixed(2)+'</td></tr>'});
h+='</table><p style="font-weight:600;font-size:11px;text-align:right;padding:4px 0;color:#475569">'+gcn(c)+' taxable total: '+P+catTax.toFixed(2)+'</p>'});
h+='<p style="font-weight:700;font-size:13px;text-align:right;padding:8px 0;border-top:2px solid #1d4ed8;margin-top:8px">Total Taxable Expenses: '+P+d.taxTot.toFixed(2)+'</p>';
} else {h+='<p style="color:#999;font-size:13px;padding:16px 0">No taxable expenses in this period.</p>'}
} else {
// Monthly: ALL expenses grouped by category, itemised, no tax
if(d.exps.length>0){
h+='<p style="color:#1d4ed8;font-size:14px;font-weight:700;margin:16px 0 8px;padding-bottom:4px;border-bottom:1px solid #ddd">Expenses</p>';
let catMap={};d.exps.forEach(e=>{let c=e.category;if(!catMap[c])catMap[c]=[];catMap[c].push(e)});
let cats=Object.keys(catMap).sort();
cats.forEach(c=>{
let items=catMap[c].sort((a,b)=>new Date(a.date)-new Date(b.date));
let catTot=items.reduce((s,e)=>s+Number(e.amount),0);
h+='<p style="font-size:13px;font-weight:700;margin:14px 0 6px;color:#334155">'+gci(c)+' '+gcn(c)+'</p>';
h+='<table style="width:100%;border-collapse:collapse;font-size:11px"><tr style="background:#1d4ed8;color:#fff"><th style="'+th+'">Date</th><th style="'+th+'">Description</th><th style="'+th+';text-align:right">Amount</th></tr>';
items.forEach((e,i)=>{h+='<tr style="'+(i%2===1?'background:#f8fafc':'')+'"><td style="'+td+'">'+new Date(e.date).toLocaleDateString('en-GB')+'</td><td style="'+td+'">'+(e.description||'-')+'</td><td style="'+tdr+';font-weight:600">'+P+Number(e.amount).toFixed(2)+'</td></tr>'});
h+='</table><p style="font-weight:600;font-size:11px;text-align:right;padding:4px 0;color:#475569">'+gcn(c)+' total: '+P+catTot.toFixed(2)+'</p>'});
h+='<p style="font-weight:700;font-size:13px;text-align:right;padding:8px 0;border-top:2px solid #1d4ed8;margin-top:8px">Total Expenses: '+P+d.tE.toFixed(2)+'</p>';
} else {h+='<p style="color:#999;font-size:13px;padding:16px 0">No expenses this month.</p>'}
}
// INCOME (same for both)
if(d.incs.length>0){
h+='<p style="color:#059669;font-size:14px;font-weight:700;margin:16px 0 8px;padding-bottom:4px;border-bottom:1px solid #ddd">Income</p>';
h+='<table style="width:100%;border-collapse:collapse;font-size:10px"><tr style="background:#059669;color:#fff"><th style="'+th+'">Date</th><th style="'+th+'">Description</th><th style="'+th+'">Source</th><th style="'+th+';text-align:right">Amount</th></tr>';
d.incs.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach((e,i)=>{
h+='<tr style="'+(i%2===1?'background:#f8fafc':'')+'"><td style="'+td+'">'+new Date(e.date).toLocaleDateString('en-GB')+'</td><td style="'+td+'">'+e.description+'</td><td style="'+td+'">'+(e.source==='uk'?'UK':'Non-UK')+'</td><td style="'+tdr+'">'+P+Number(e.amount).toFixed(2)+'</td></tr>'});
h+='</table><p style="font-weight:700;font-size:12px;text-align:right;padding:6px 0;border-top:2px solid #059669">Total Income: '+P+d.tI.toFixed(2)+'</p>'}
// SUMMARY
h+='<div style="margin-top:16px;padding:16px;background:#f1f5f9;border-radius:8px;border:1px solid #e2e8f0">';
h+='<p style="color:#1d4ed8;font-size:13px;font-weight:700;margin-bottom:8px">Summary</p>';
h+='<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:12px"><span>Total Income</span><span>'+P+d.tI.toFixed(2)+'</span></div>';
if(isTax){
h+='<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:12px"><span>Total Taxable Expenses</span><span>'+P+d.taxTot.toFixed(2)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:12px;color:#94a3b8"><span>Total Expenses (all)</span><span>'+P+d.tE.toFixed(2)+'</span></div>';
let net=d.tI-d.taxTot;
h+='<div style="display:flex;justify-content:space-between;padding:6px 0 0;font-size:13px;font-weight:700;border-top:1px solid #cbd5e1;margin-top:6px"><span>Net (income ‚àí taxable)</span><span style="color:'+(net>=0?'#059669':'#dc2626')+'">'+(net>=0?'+':'')+P+net.toFixed(2)+'</span></div>';
} else {
h+='<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:12px"><span>Total Expenses</span><span>'+P+d.tE.toFixed(2)+'</span></div>';
let net=d.tI-d.tE;
h+='<div style="display:flex;justify-content:space-between;padding:6px 0 0;font-size:13px;font-weight:700;border-top:1px solid #cbd5e1;margin-top:6px"><span>Net</span><span style="color:'+(net>=0?'#059669':'#dc2626')+'">'+(net>=0?'+':'')+P+net.toFixed(2)+'</span></div>';
}
h+='</div></div>';
h+='<p style="color:#94a3b8;font-size:12px;text-align:center;margin-top:12px">To save as PDF: Share ‚Üí Print ‚Üí Save as PDF</p>';
return h+bb('go-dash','Back to Dashboard');
}

function rExport(){
if(!S.exportStep){return '<div class="hdr"><span class="hdr-t">Export</span></div><div class="cnt"><p class="sl">What would you like to export?</p><div class="cl">'+
'<button class="cr" data-action="exp-scope" data-val="month"><div class="cri"><span class="cri-i">üìÖ</span><div class="cri-t"><span class="cri-n">This Month</span></div></div><span class="chv">‚Ä∫</span></button>'+
'<button class="cr" data-action="exp-scope" data-val="taxyear"><div class="cri"><span class="cri-i">üìã</span><div class="cri-t"><span class="cri-n">Current Tax Year</span></div></div><span class="chv">‚Ä∫</span></button>'+
'<button class="cr" data-action="exp-step" data-val="browse-months"><div class="cri"><span class="cri-i">üóìÔ∏è</span><div class="cri-t"><span class="cri-n">Monthly Reports</span></div></div><span class="chv">‚Ä∫</span></button>'+
'<button class="cr" data-action="exp-step" data-val="browse-tax"><div class="cri"><span class="cri-i">üìÅ</span><div class="cri-t"><span class="cri-n">Tax Years</span></div></div><span class="chv">‚Ä∫</span></button>'+
'</div></div>'+bb('go-dash','Back')}
if(S.exportStep==='browse-months'){
let mks={};S.expenses.forEach(e=>{let k=gmk(e.date);mks[k]=1});S.income.forEach(e=>{let k=gmk(e.date);mks[k]=1});
let months=Object.keys(mks).sort().reverse();
let ml=months.length===0?'<p class="et">No data yet</p>':months.map(m=>'<button class="cr" data-action="exp-pick-month" data-id="'+m+'"><div class="cri"><span class="cri-i">üìÖ</span><div class="cri-t"><span class="cri-n">'+gml(m)+'</span></div></div><span class="chv">‚Ä∫</span></button>').join('');
return '<div class="hdr"><span class="hdr-t">Monthly Reports</span></div><div class="cnt"><p class="sl">Choose a month</p><div class="cl">'+ml+'</div></div>'+bb('exp-reset','Back')}
if(S.exportStep==='browse-tax'){
let tys=[];
let cst=new Date(S.tyStart),cy1=cst.getFullYear(),cy2=cy1+1;
tys.push({label:cy1+'/'+cy2,start:S.tyStart,end:null,scope:'taxyear'});
if(S.pastTY&&S.pastTY.length>0){S.pastTY.slice().reverse().forEach((pt,i)=>{tys.push({label:pt.label,idx:i,scope:'pasttax-'+i})})}
let allDates=S.expenses.map(e=>new Date(e.date)).concat(S.income.map(e=>new Date(e.date)));
if(allDates.length>0){
let earliest=new Date(Math.min(...allDates));
let ey=earliest.getMonth()>=3?earliest.getFullYear():earliest.getFullYear()-1;
let ly=new Date().getMonth()>=3?new Date().getFullYear():new Date().getFullYear()-1;
for(let yr=ly;yr>=ey;yr--){
let lbl=yr+'/'+(yr+1);
if(!tys.find(t=>t.label===lbl)){tys.push({label:lbl,start:yr+'-04-06',end:(yr+1)+'-04-05',scope:'histtax-'+yr})}
}}
let tl=tys.map(t=>'<button class="cr" data-action="exp-pick-tax" data-id="'+t.scope+'" data-val="'+t.label+'"><div class="cri"><span class="cri-i">üìã</span><div class="cri-t"><span class="cri-n">'+t.label+'</span></div></div><span class="chv">‚Ä∫</span></button>').join('');
return '<div class="hdr"><span class="hdr-t">Tax Years</span></div><div class="cnt"><p class="sl">Choose a tax year</p><div class="cl">'+tl+'</div></div>'+bb('exp-reset','Back')}
if(S.exportStep==='fmt'){
let lbl=S.exportScope==='month'?gml(S.selMonth):S.exportScope==='taxyear'?'Tax Year '+tyl():S.exportTitle||'Export';
return '<div class="hdr"><span class="hdr-t">Export '+lbl+'</span></div><div class="cnt"><p class="sl">Choose format</p><div style="display:flex;gap:12px">'+
'<button class="bb2" data-action="do-exp" data-val="pdf"><span class="bb2-i">üìÑ</span><span class="bb2-l">PDF</span></button>'+
'<button class="bb2" data-action="do-exp" data-val="csv"><span class="bb2-i">üìä</span><span class="bb2-l">CSV</span></button></div></div>'+bb('exp-reset','Back')}
return rDash();
}

function renderConfirm(){
let showCancel=S.confirm.showCancel!==false;
return '<div class="co"><div class="cob"><p class="cot">'+S.confirm.title+'</p><p class="cox">'+S.confirm.text+'</p><div class="br">'+
(showCancel?'<button class="sb" data-action="cf-no">Cancel</button>':'')+
'<button class="pb" data-action="cf-yes" style="'+(showCancel?'background:linear-gradient(135deg,#dc2626,#ef4444)':'background:linear-gradient(135deg,#1d4ed8,#3b82f6)')+'">'+
(showCancel?'Confirm':'OK')+'</button></div></div></div>';
}

function bind(){
document.querySelectorAll('[data-action]').forEach(el=>el.addEventListener('click',ha));
['aA','aD','iA','iD','aP','eA','eD','eP','eiA','eiD','sI','nCN','nCI'].forEach(id=>{let el=document.getElementById(id);if(el)el.addEventListener('input',hi)});
}

function hi(e){
let id=e.target.id,v=e.target.value;
switch(id){
case 'aA':S.addExp.amount=v;{let b=document.querySelector('[data-action="en1"]');if(b)b.disabled=!v||parseFloat(v)<=0}break;
case 'aD':S.addExp.description=v;{let b=document.querySelector('[data-action="en2"]');if(b)b.disabled=!v.trim()}break;
case 'iA':S.addInc.amount=v;{let b=document.querySelector('[data-action="in1"]');if(b)b.disabled=!v||parseFloat(v)<=0}break;
case 'iD':S.addInc.description=v;{let b=document.querySelector('[data-action="in2"]');if(b)b.disabled=!v.trim()}break;
case 'aP':S.addExp.taxPct=v;{let b=document.querySelector('[data-action="esv"]');if(b)b.disabled=!v}break;
case 'eA':S.editData.amount=v;break;case 'eD':S.editData.description=v;break;case 'eP':S.editData.taxPct=v;break;
case 'eiA':S.editData.amount=v;break;case 'eiD':S.editData.description=v;break;
case 'sI':S.searchQ=v;render();setTimeout(()=>{let si=document.getElementById('sI');if(si){si.focus();si.setSelectionRange(si.value.length,si.value.length)}},0);break;
case 'nCN':S.newCN=v;break;case 'nCI':S.newCI=v;break;
}}

function ha(e){
let el=e.currentTarget,a=el.dataset.action,id=el.dataset.id,val=el.dataset.val;
switch(a){
case 'go-dash':S.view='dashboard';S.editing=null;S.addStep=0;S.exportStep=null;S.exportScope=null;render();break;
case 'go-add-type':S.view='add-type';render();break;
case 'go-search-type':S.view='search-type';S.searchQ='';render();break;
case 'go-stype':S.view='search-type';S.searchQ='';render();break;
case 'go-export':S.view='export';S.exportStep=null;S.exportScope=null;S.exportTitle=null;render();break;
case 'go-settings':S.view='settings';render();break;
case 'go-tax':S.view='tax';render();break;
case 'go-vat':S.view='vat';render();break;
case 'go-pty':S.view='past-tax';render();break;
case 'go-inc-list':S.view='inc-list';render();break;
case 'go-exp-list':S.view='exp-list';render();break;
case 'go-trends':S.view='trends';render();break;
case 'prev-m':{let[y,m]=S.selMonth.split('-').map(Number);S.selMonth=gmk(new Date(y,m-2));render();break}
case 'next-m':{let[y,m]=S.selMonth.split('-').map(Number);S.selMonth=gmk(new Date(y,m));render();break}
case 'start-add-exp':S.view='add-exp';S.addStep=0;S.addExp={amount:'',description:'',category:'',taxable:'no',taxPct:''};render();break;
case 'start-add-inc':S.view='add-inc';S.addStep=0;S.addInc={amount:'',description:'',source:'uk'};render();break;
case 'en1':S.addStep=1;render();break;
case 'en2':S.addStep=2;render();break;
case 'esc':S.addExp.category=id;S.addStep=3;render();break;
case 'etx':S.addExp.taxable=val;if(val!=='pct')S.addExp.taxPct='';render();break;
case 'esv':doAddExp();break;
case 'in1':S.addStep=1;render();break;
case 'in2':S.addStep=2;render();break;
case 'isr':S.addInc.source=val;render();break;
case 'isv':doAddInc();break;
case 'view-cat':S.selCat=id;S.view='category';render();break;
case 'eei':{let ex=S.expenses.find(x=>x.id===id);if(ex){S.editing=ex;S.editData={amount:ex.amount,description:ex.description||'',category:ex.category,taxable:ex.taxable||'no',taxPct:ex.taxPct||''};S.view='edit-exp';render()}break}
case 'eec':S.editData.category=id;render();break;
case 'eet':S.editData.taxable=val;if(val!=='pct')S.editData.taxPct='';render();break;
case 'sve-exp':{let am=parseFloat(S.editData.amount),ta=0;if(S.editData.taxable==='yes')ta=am;else if(S.editData.taxable==='pct')ta=am*(parseFloat(S.editData.taxPct)||0)/100;
S.expenses=S.expenses.map(x=>x.id===S.editing.id?{...x,amount:am,description:S.editData.description,category:S.editData.category,taxable:S.editData.taxable,taxPct:S.editData.taxPct,taxAmount:ta}:x);sE();S.editing=null;S.view='dashboard';render();break}
case 'del-exp':S.expenses=S.expenses.filter(x=>x.id!==S.editing.id);sE();S.editing=null;S.view='dashboard';render();break;
case 'eii':{let inc=S.income.find(x=>x.id===id);if(inc){S.editing=inc;S.editData={amount:inc.amount,description:inc.description,source:inc.source};S.view='edit-inc';render()}break}
case 'eis':S.editData.source=val;render();break;
case 'sve-inc':S.income=S.income.map(x=>x.id===S.editing.id?{...x,amount:parseFloat(S.editData.amount),description:S.editData.description,source:S.editData.source}:x);sI();S.editing=null;S.view='dashboard';render();break;
case 'del-inc':S.income=S.income.filter(x=>x.id!==S.editing.id);sI();S.editing=null;S.view='dashboard';render();break;
case 's-exp':S.searchMode='expenses';S.searchQ='';S.view='search';render();break;
case 's-inc':S.searchMode='income';S.searchQ='';S.view='search';render();break;
case 'del-cat':S.categories=S.categories.filter(c=>c.id!==id);sC();render();break;
case 'add-cat':if(!S.newCN.trim())break;S.categories.push({id:S.newCN.toLowerCase().replace(/\s+/g,'-'),name:S.newCN.trim(),icon:S.newCI||'üìå'});sC();S.newCN='';S.newCI='üìå';render();break;
case 'save-tys':{let el2=document.getElementById('tyS');if(el2){S.tyStart=el2.value;sTS();render()}break}
case 'do-backup':{
let data={version:1,exportDate:new Date().toISOString(),expenses:S.expenses,income:S.income,categories:S.categories,pastTY:S.pastTY,tyStart:S.tyStart};
let json=JSON.stringify(data,null,2);
let blob=new Blob([json],{type:'application/json'});
let url=URL.createObjectURL(blob);
let a=document.createElement('a');
a.href=url;a.download='finance-backup-'+new Date().toISOString().slice(0,10)+'.json';
a.click();URL.revokeObjectURL(url);
localStorage.setItem('ft-lastbackup',new Date().toISOString());
render();break}
case 'do-restore':{try{let fi=document.getElementById('restoreFile');if(!fi){fi=document.createElement('input');fi.type='file';fi.accept='.json';fi.id='restoreFile';fi.style.display='none';document.body.appendChild(fi)}fi.value='';fi.onchange=function(){
let file=fi.files&&fi.files[0];if(!file)return;
let reader=new FileReader();
reader.onerror=function(){S.confirm={title:'Restore Failed',text:'Could not read the file. Please try again.',showCancel:false,onYes:function(){S.confirm=null;render()}};render()};
reader.onload=function(ev){
try{
let data=JSON.parse(ev.target.result);
if(!data.expenses&&!data.income){throw new Error('Invalid backup')}
if(data.expenses)S.expenses=data.expenses;
if(data.income)S.income=data.income;
if(data.categories)S.categories=data.categories;
if(data.pastTY)S.pastTY=data.pastTY;
if(data.tyStart)S.tyStart=data.tyStart;
sE();sI();sC();sT();sTS();
S.selMonth=cmk();S.view='dashboard';
S.confirm={title:'Restore Complete ‚úÖ',text:'All your data has been restored successfully. '+S.expenses.length+' expenses and '+S.income.length+' income entries loaded.',showCancel:false,onYes:function(){S.confirm=null;render()}};
render();
}catch(err){S.confirm={title:'Restore Failed',text:'The file could not be read. Please make sure it is a valid Finance Tracker backup file.',showCancel:false,onYes:function(){S.confirm=null;render()}};render()}
};reader.readAsText(file)};fi.click()}catch(err){S.confirm={title:'Restore Failed',text:'Something went wrong. Please try again.',showCancel:false,onYes:function(){S.confirm=null;render()}};render()}break}
case 'reset-ty':S.confirm={title:'Reset Tax Year?',text:'This will close tax year '+tyl()+' and start a new one. All data is kept in Past Tax Years.',onYes:function(){
let te=gte(),st=new Date(S.tyStart),now=new Date();
let ae=S.expenses.filter(x=>{let d=new Date(x.date);return d>=st&&d<=now});
let ai=S.income.filter(x=>{let d=new Date(x.date);return d>=st&&d<=now});
S.pastTY.push({label:tyl(),totalTaxable:te.reduce((s,e)=>s+Number(e.taxAmount),0),totalExpenses:ae.reduce((s,e)=>s+Number(e.amount),0),totalIncome:ai.reduce((s,e)=>s+Number(e.amount),0),closedDate:new Date().toISOString()});
sT();let ny=new Date(),yr=ny.getMonth()>=3?ny.getFullYear():ny.getFullYear()-1;S.tyStart=yr+'-04-06';sTS();S.confirm=null;render()}};render();break;
case 'cf-yes':if(S.confirm&&S.confirm.onYes)S.confirm.onYes();S.confirm=null;render();break;
case 'cf-no':S.confirm=null;render();break;
case 'exp-scope':S.exportScope=val;S.exportStep='fmt';S.exportTitle=null;render();break;
case 'exp-step':S.exportStep=val;render();break;
case 'exp-reset':S.exportStep=null;S.exportScope=null;S.exportTitle=null;render();break;
case 'exp-pick-month':{S.exportScope='pick-month';S.exportPickMonth=id;S.exportTitle=gml(id);S.exportStep='fmt';render();break}
case 'exp-pick-tax':{let scope=id,lbl=val;S.exportScope=scope;S.exportTitle='Tax Year '+lbl;S.exportStep='fmt';render();break}
case 'do-exp':doExport(val);break;
}}

function doAddExp(){
let am=parseFloat(S.addExp.amount),ta=0;
if(S.addExp.taxable==='yes')ta=am;else if(S.addExp.taxable==='pct')ta=am*(parseFloat(S.addExp.taxPct)||0)/100;
S.expenses.unshift({id:Date.now().toString(),amount:am,description:S.addExp.description,category:S.addExp.category,taxable:S.addExp.taxable,taxPct:S.addExp.taxPct,taxAmount:ta,date:new Date().toISOString()});
sE();S.addExp={amount:'',description:'',category:'',taxable:'no',taxPct:''};S.addStep=0;S.view='dashboard';render();
}
function doAddInc(){
S.income.unshift({id:Date.now().toString(),amount:parseFloat(S.addInc.amount),description:S.addInc.description,source:S.addInc.source,date:new Date().toISOString()});
sI();S.addInc={amount:'',description:'',source:'uk'};S.addStep=0;S.view='dashboard';render();
}

function doExport(fmt){
let exps=[],incs=[],title='',scope='month';
if(S.exportScope==='month'){exps=gme();incs=gmi();title=gml(S.selMonth);scope='month'}
else if(S.exportScope==='taxyear'){let st=new Date(S.tyStart),now=new Date();exps=S.expenses.filter(e=>{let d=new Date(e.date);return d>=st&&d<=now});incs=S.income.filter(e=>{let d=new Date(e.date);return d>=st&&d<=now});title='Tax Year '+tyl();scope='taxyear'}
else if(S.exportScope==='pick-month'){let mk=S.exportPickMonth;exps=S.expenses.filter(e=>gmk(e.date)===mk);incs=S.income.filter(e=>gmk(e.date)===mk);title=gml(mk);scope='month'}
else if(S.exportScope&&S.exportScope.startsWith('histtax-')){let yr=parseInt(S.exportScope.split('-')[1]);let st=new Date(yr+'-04-06'),en=new Date((yr+1)+'-04-05T23:59:59');exps=S.expenses.filter(e=>{let d=new Date(e.date);return d>=st&&d<=en});incs=S.income.filter(e=>{let d=new Date(e.date);return d>=st&&d<=en});title='Tax Year '+yr+'/'+(yr+1);scope='taxyear'}
else{exps=[...S.expenses];incs=[...S.income];title=S.exportTitle||'All Data';scope='taxyear'}
if(fmt==='csv'){
let rows=[['Type','Date','Amount (¬£)','Category/Description','Source','Taxable','Tax Amount (¬£)']];
exps.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(e=>{rows.push(['Expense',new Date(e.date).toLocaleDateString('en-GB'),Number(e.amount).toFixed(2),(e.description?e.description+' - ':'')+gcn(e.category),'',e.taxable==='no'?'No':e.taxable==='yes'?'Yes (100%)':e.taxPct+'%',Number(e.taxAmount||0).toFixed(2)])});
incs.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(e=>{rows.push(['Income',new Date(e.date).toLocaleDateString('en-GB'),Number(e.amount).toFixed(2),e.description,e.source==='uk'?'UK':'Non-UK','',''])});
let csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
let blob=new Blob([csv],{type:'text/csv'}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download='finances-'+title.replace(/\s+/g,'-').toLowerCase()+'.csv';a.click();URL.revokeObjectURL(url)
}else{
let tE=exps.reduce((s,e)=>s+Number(e.amount),0),tI=incs.reduce((s,e)=>s+Number(e.amount),0);
let taxTot=exps.filter(e=>e.taxable!=='no'&&Number(e.taxAmount)>0).reduce((s,e)=>s+Number(e.taxAmount),0);
let P=String.fromCharCode(163);
S.reportData={exps,incs,title,tE,tI,taxTot,P,scope:scope};
S.exportStep=null;S.exportScope=null;S.exportTitle=null;S.view='report';render();return;
}
S.exportStep=null;S.exportScope=null;S.exportTitle=null;S.view='dashboard';render();
}

ld();render();
})();
</script></body></html>
